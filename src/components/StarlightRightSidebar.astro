---
import yaml from "js-yaml";
import path from "node:path";
import { existsSync, readFileSync } from "node:fs";
import { Image } from "astro:assets";
import TableOfContents from "@astrojs/starlight/components/TableOfContents.astro";
import { slugify } from "../utils/slugify";
import { CATEGORIES } from "../config/categories";

let driverInfo: Record<string, any> = {};
let driverManufacturerDisplay = "N/A";
let driverWebsite = "";
let thumbnailPath: any = "";

// Extract driverId from the current URL path
// Example: /mounts/sky-watcher/eqmod/ -> mounts/sky-watcher/eqmod
const currentPath = Astro.url.pathname;
let driverId = "";
if (currentPath.startsWith("/")) {
  driverId = currentPath.substring(1).replace(/\/$/, "");
}

const driverIdParts = driverId.split("/");

// New 4-part URL structure: /category/manufacturer/driver/driver
// Example: /mounts/sky-watcher/eqmod/eqmod
if (driverIdParts.length === 4) {
  const driverCategorySlug = slugify(driverIdParts[0]);
  const driverManufacturerSlug = slugify(driverIdParts[1]);
  const driverSlug = slugify(driverIdParts[2]);

  const contentDirPath = path.resolve(
    process.cwd(),
    `src/content/docs/${driverCategorySlug}/${driverManufacturerSlug}/${driverSlug}`,
  );

  // The try-catch block was malformed, ensuring it's correct now.
  try {
    if (existsSync(contentDirPath)) {
      const yamlFileName = `${driverSlug}.yaml`;
      const potentialYamlPath = path.resolve(contentDirPath, yamlFileName);

      if (existsSync(potentialYamlPath)) {
        const fileContents = readFileSync(potentialYamlPath, "utf8");
        driverInfo = yaml.load(fileContents) as Record<string, any>;

        // Extract manufacturer for display
        if (driverInfo && typeof driverInfo === "object") {
          if (driverInfo.manufacturer_name) {
            driverManufacturerDisplay = driverInfo.manufacturer_name as string;
          } else if (driverInfo.manufacturer) {
            driverManufacturerDisplay = driverInfo.manufacturer as string;
          }
          if (driverInfo.website) {
            driverWebsite = driverInfo.website as string;
            // Ensure the website URL is absolute
            if (
              !driverWebsite.startsWith("http://") &&
              !driverWebsite.startsWith("https://")
            ) {
              driverWebsite = `https://${driverWebsite}`;
            }
          }
        }
      }

      // Use the thumbnail from the content directory (co-located with markdown)
      const thumbnailFilePath = path.resolve(
        contentDirPath,
        `${driverSlug}.webp`,
      );
      if (existsSync(thumbnailFilePath)) {
        thumbnailPath = `/src/content/docs/${driverCategorySlug}/${driverManufacturerSlug}/${driverSlug}/${driverSlug}.webp`;
      }
    }
  } catch (e) {
    console.error(
      `StarlightRightSidebar: Error processing YAML for ${driverId}:`,
      e,
    );
  }
}
---

<aside class="starlight-right-sidebar">
  {
    thumbnailPath &&
      (driverWebsite ? (
        <a
          href={driverWebsite}
          target="_blank"
          rel="noopener noreferrer"
          class="driver-thumbnail-link"
        >
          <Image
            src={thumbnailPath}
            alt="Driver Thumbnail"
            width={320}
            height={180}
            class="driver-thumbnail"
          />
        </a>
      ) : (
        <div class="driver-thumbnail-link">
          <Image
            src={thumbnailPath}
            alt="Driver Thumbnail"
            width={320}
            height={180}
            class="driver-thumbnail"
          />
        </div>
      ))
  }

  {
    Object.entries(driverInfo).length > 0 ? (
      <div class="driver-info-container">
        <div class="info-row">
          <div class="info-label">Manufacturer</div>
          <div class="info-value">{driverManufacturerDisplay}</div>
        </div>
        {Object.entries(driverInfo)
          .filter(
            ([key]) =>
              key.toLowerCase() !== "manufacturer" &&
              key.toLowerCase() !== "manufacturer_name" &&
              key.toLowerCase() !== "category_name" &&
              key.toLowerCase() !== "driver_name" &&
              key.toLowerCase() !== "website",
          )
          .map(([key, value]) => {
            let displayValue = String(value);

            // Convert category slugs to human-readable names
            if (key.toLowerCase() === "categories" && Array.isArray(value)) {
              displayValue = value
                .map((cat: string) => {
                  const catSlug = slugify(cat);
                  return CATEGORIES[catSlug as keyof typeof CATEGORIES] || cat;
                })
                .join(", ");
            }

            return (
              <div class="info-row">
                <div class="info-label">
                  {key
                    .split("_")
                    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(" ")}
                </div>
                <div class="info-value">{displayValue}</div>
              </div>
            );
          })}
      </div>
    ) : (
      <p class="no-info">No driver information available.</p>
    )
  }

  <hr class="starlight-sidebar-separator" />

  <TableOfContents />
</aside>

<style>
  .starlight-right-sidebar {
    display: flex;
    flex-direction: column;
    padding: 1rem;
    border-left: 1px solid var(--sl-color-gray-5);
    margin-left: 1.5rem;
    width: max-content;
  }

  .driver-thumbnail-link {
    display: block;
    margin-bottom: 1.5rem;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    transition: transform 0.2s ease;
  }

  .driver-thumbnail-link:hover {
    transform: translateY(-3px);
  }

  .driver-thumbnail {
    display: block;
    width: 100%;
    height: auto;
    object-fit: cover;
  }

  .driver-info-container {
    display: flex;
    flex-direction: column;
    border: 2px solid #383c4a;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    background-color: #23262d;
    max-width: 20rem;
  }

  .info-row {
    display: flex;
    border-bottom: 1px solid #383c4a;
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .info-row:nth-child(even) {
    background-color: rgba(255, 255, 255, 0.03);
  }

  .info-row:hover {
    background-color: rgba(136, 58, 234, 0.15);
    transition: background-color 0.2s ease;
  }

  .info-label {
    flex-shrink: 0;
    width: 120px;
    padding: 0.875rem 1rem;
    font-weight: 700;
    color: #e1e4e8;
    font-size: 0.875rem;
    border-right: 2px solid #383c4a;
    background-color: rgba(255, 255, 255, 0.02);
  }

  .info-value {
    flex: 1;
    padding: 0.875rem 1rem;
    color: #c9d1d9;
    font-size: 0.875rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    hyphens: auto;
    font-weight: 400;
    min-width: 0;
  }

  .no-info {
    color: var(--sl-color-gray-3);
    font-style: italic;
    padding: 1rem;
    text-align: center;
  }

  .starlight-sidebar-separator {
    border: none;
    border-top: 1px solid var(--sl-color-gray-5);
    margin: 1.5rem 0;
  }
</style>
